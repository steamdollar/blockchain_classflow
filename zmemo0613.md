블럭을 아무나 쉽게 만들 수 있으면 안 됨..

그래서 제한을 건게 바로 작업 증명 POW / proof of work = 채굴

컴퓨터가 문제를 풀면 됨..

풀면 네트워크의 다른 컴퓨터에 알려주고 블록을 같이 준다.

그럼 다른 컴퓨터가 그걸 체크

그게 방금 isValidBlock 함수임. 이게 나 혼자 할땐 당연해도 다른 사람이 준건 안 당연해서

조건을 3개나 건거다..

만약 검증이 통과된다면 체인에 넣는거고 아니면 버리고..

이제 chk3부터는 그걸 넣어볼거다..

POW란 뭔가

(hash)16진수를 2진수로 바꾸고, 그 2진수가 앞자리에 0이 몇개인지를 세는게 pow..

문제 난이도도 이걸 바꿔줌으로써 바꿀 수 있다.

앞자리에 0이 1개, 2개...

0의 수가 많아질수록 만족하는 숫자의 수도 적어지니 난이도는 상승한다.

만약 누군가 문제를 풀어 블럭 생성에 성공할 경우,

새로운 해시를 만들기 위해

nonce값을 임의로 지정한다.

///////////////////////////

난이도, nonce 값을 추가해 채굴 기능을 구현해보자. (chk4)

difficulty : 10개 정도 블럭의 평균 생성 소요 시간을 지정한다.

1. 1개 블럭 생성 시간을 평균 10분 정도로 지정

2. 평균 시간을 구하는 블럭 갯수를 10개로 한다.

너무 길면 낮추고, 짧으면 높힌다.

난이도도 윾동적이야.

이걸 지정하는 식을 만들고

체인을 구현해보는게 두 번째

이걸 하면 드디어 채굴 기능이 구현 됨.

체인 > 난이도 > 채굴 순으로 기능을 구현해본다.



업데이트 간격을 10이라고 잡으면 10개 블럭이 생성되는 시간을 타임스탬프 차를 이용해 구한다.
기준을 한 6천초로 맞추고 싶은데 5800이 나왔다? 난이도를 높히던가 별 차이가 없다 싶으면 놔두고..
난이도를 바꾸고 싶으면 difficulty를 높히면 됨.

addblock 함수에서 조건식을 만들자.
addblock 함수의 실행은 아직 만들어지진 않았지만 이제 만들거라는 의미이기 때문.

config.ts에 만들어준 상수들이 그거임..

아무튼 이제 이걸 구현해보자.

1. 생성할 블럭의 높이값을 가져온다.

height = previousBlock.height + 1

2. 10개 전 블럭의 높이?

이건 음수가 나올 수도 있다. > 그럼 블럭이 10개 안된다는거니까 그냥 제네시스 블럭을 바라보게 하면 된다.

그게 ? Block.getGenesis()

10보다 크면 currentLength - interval > 이 높이에 해당하는 Block을 반환한다.

이상의 내용을 가진 함수 getAdjustment를 addBlock에 넣어주면 됨.

//

이제 난이도를 구한다.

timestamp의 차를 구해 10개 블럭의 생성 시간을 이용해 찾을 수 있다.

addBlock 안에는 아직 생성할 블럭에 관한 정보가 없기 떄문에 이 안에서 해결할 수는 없다.

addBlock 함수 내에서 호출한 generateBlock 함수에 인자값을 하나 추가해주면 된다.

_addjustmentBlock 을 매개변수로 추가한다.

+ block.ts로 가서 getDifficulty 함수를 추가한다.

여기서 해야 생성된 블럭의 정보가 존재해서 그걸 가져올 있음

함수를 완성했으면

이걸 constructor의 difficulty에 넣어줘야 하는데, 매개변수 2개가 각각

this, _adjustmentBlock이다.

근데 adjustmentBlock은 매개변수로 넣어주려면 먼저 generate 블럭에 _adjustmentBlock을 넣어야 한다.

여까지 하면 난이도를 구한거..

이제 테스트 해보자.

chain.test.ts

에러 낭ㅁ..

난이도를 바꾸는데는 전 블럭의 난이도 (변화 없을 경우) or adjustmentBlock 의 난이도 + 1 을 가져오면 된다.

//////////////////

0613- 2 

hash는 16진수, 16진수는 2진수랑 관계가 깊다.

16 진수 한 글자 = 4 bit, 두 글자는 8bit = 1 byte

16글자는 32바이트

2진수 0000 ~ 1111 => 16진수 0 ~ F 한글자로 변환이 됨

만약 16진수를 2진수로 바꾸면 무적권 4배의 digit을 가지게 된다.

POW는 hash 값을 통해 앞에 몇개 자릿수가 0으로 채워지는지를 보는거다.

난이도가 1일 때

hash 를 2진수를 바꾸면 첫 1개의 digit이 0인수를 찾는거..

이 사실을 바탕으로 findBlock 함수에 마이닝 관련 코드를 만들어보자.

여기서 do while문이 개입한다.

특정 조건을 만족할때까지 계속 연산을 돌려야 하므로..

/////

네트워크 내에서 이걸 주고 받고 하면서 서버 클라이언트는 수시로 바뀌는데,

여기서 개입하는게 http, websocket

src/core/index.ts
여기 체인을 가져오고

~/index.ts
에 서버를 만들어줄거다..

tsconfig.json 에도 ts-node 항목을 추가

npx ts-node index.ts 입력하면 서버가 구동된다.

npm run dev:ts index.ts

채굴을 하려면..

server 구현은 index.tx 참조

//

websocket

P2Pserver.. serve/p2p.ts 에 정리해둠..

//